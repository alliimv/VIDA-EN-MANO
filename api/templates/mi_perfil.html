<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Perfil | Vida en Mano</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; color: white; display: inline-block; }
        .badge-enfermero { background: #3b82f6; }
        .badge-medico { background: #8b5cf6; }
        .badge-familiar { background: #10b981; }
        .btn { display: inline-block; padding: 10px 20px; background: #3b82f6; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .no-pacientes { background: #fef3c7; padding: 20px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>üë§ {{ 'Mi Perfil' if logged_in else 'Perfil P√∫blico' }}</h1>
            <a href="{{ url_for('dashboard') if logged_in else url_for('home') }}" class="btn" style="background: #6b7280;">
                ‚Üê {{ 'Dashboard' if logged_in else 'Inicio' }}
            </a>
        </div>

        <!-- INFORMACI√ìN PERSONAL -->
        <div class="card">
            <h2>Informaci√≥n de Cuenta</h2>
            <div style="display: flex; gap: 30px; align-items: center; margin-top: 20px;">
                <div style="font-size: 3rem; background: #f3f4f6; padding: 20px; border-radius: 50%;">
                    {% if usuario.tipo_usuario == 'enfermero' %}üë©‚Äç‚öïÔ∏è
                    {% elif usuario.tipo_usuario == 'medico' %}üë®‚Äç‚öïÔ∏è
                    {% elif usuario.tipo_usuario == 'familiar' %}üë™
                    {% else %}üë§{% endif %}
                </div>
                <div>
                    <h3>{{ usuario.nombre_completo or usuario.username }}</h3>
                    <p><strong>Tipo de Usuario:</strong>
                        <span class="badge badge-{{ usuario.tipo_usuario }}">
                            {% if usuario.tipo_usuario == 'enfermero' %}Enfermero/a
                            {% elif usuario.tipo_usuario == 'medico' %}M√©dico
                            {% elif usuario.tipo_usuario == 'familiar' %}Familiar Autorizado
                            {% else %}Invitado{% endif %}
                        </span>
                    </p>

                    {% if logged_in %}
                    <div style="margin-top:12px;">
                        <a href="{{ url_for('cambiar_contrasena') }}" class="btn" style="background:#ef4444;">
                            üîí Cambiar contrase√±a
                        </a>
                        <!-- ...existing actions... -->
                    </div>
                    {% endif %}

                    {% if usuario.tipo_usuario == 'familiar' and usuario.parentesco %}
                    <p><strong>Parentesco:</strong> {{ usuario.parentesco }}</p>
                    {% endif %}

                    {% if logged_in and usuario.fecha_creacion %}
                    <p><strong>Miembro desde:</strong> {{ usuario.fecha_creacion.strftime('%d/%m/%Y') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PACIENTES -->
        <div class="card">
            <h2>üìã Mis Pacientes</h2>

            {% if usuario.error %}
            <div class="no-pacientes">
                <p style="font-size: 1.2em; color: #92400e;">‚ö†Ô∏è {{ usuario.error }}</p>
                {% if usuario.tipo_usuario == 'familiar' %}
                <p>Contacta con el administrador para que te asigne un paciente.</p>
                {% endif %}
            </div>

            {% elif asignaciones and asignaciones|length > 0 %}
                {% if usuario.tipo_usuario in ['enfermero', 'medico', 'admin'] %}
                <p><strong>Acceso completo:</strong> Puedes ver todos los pacientes ({{ asignaciones|length }} en total)</p>
                {% else %}
                <p><strong>Paciente asignado:</strong> Solo puedes ver este paciente</p>
                {% endif %}

                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Paciente</th>
                            <th>Edad</th>
                            <th>Relaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for paciente in asignaciones %}
                        <tr>
                            <td>#{{ paciente.id_paciente|format_id }}</td>
                            <td>
                                <strong>{{ paciente.nombre }} {{ paciente.apellido_paterno }}</strong>
                                {% if paciente.apellido_materno %}
                                {{ paciente.apellido_materno }}
                                {% endif %}
                            </td>
                            <td>
                                {% if paciente.fecha_nacimiento %}
                                    {% set hoy = now().date() %}
                                    {% set edad = hoy.year - paciente.fecha_nacimiento.year - ((hoy.month, hoy.day) < (paciente.fecha_nacimiento.month, paciente.fecha_nacimiento.day)) %}
                                    {{ edad }} a√±os
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ paciente.parentesco }}</td>
                            <td>
                                <a href="{{ url_for('ver_pacientes') }}?paciente={{ paciente.id_paciente }}" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">
                                    üëÅÔ∏è Ver
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            {% else %}
            <div class="no-pacientes">
                <p>No hay pacientes para mostrar.</p>
                {% if usuario.tipo_usuario in ['enfermero', 'medico', 'admin'] %}
                <a href="{{ url_for('agregar_paciente') }}" class="btn" style="background: #10b981; margin-top: 10px;">
                    ‚ûï Agregar Paciente
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</body>
</html>